import discord
from discord import app_commands
from config import load_config, save_config
from views import CreateTicketView

async def setup(bot):
    # ... (keep your existing setup and ticket commands)

    @bot.tree.command(name="add", description="Add a user to the current ticket")
    async def add_user_to_ticket(interaction: discord.Interaction, user: discord.Member):
        """Adds a user to the current ticket thread"""
        await interaction.response.defer(ephemeral=True)
        
        # Check if this is a ticket thread
        if not isinstance(interaction.channel, discord.Thread):
            await interaction.followup.send("❌ This command can only be used in ticket threads.", ephemeral=True)
            return
        
        config = load_config(interaction.guild.id)
        has_permission = False

        # Check if user is the ticket owner
        thread_name_parts = interaction.channel.name.split('-')
        if len(thread_name_parts) >= 2 and thread_name_parts[1].isdigit():
            ticket_owner_id = int(thread_name_parts[1])
            if interaction.user.id == ticket_owner_id:
                has_permission = True

        # Check support role
        if not has_permission and config.get("support_role"):
            support_role = interaction.guild.get_role(config["support_role"])
            if support_role and support_role in interaction.user.roles:
                has_permission = True

        # Check admin permissions
        if not has_permission and interaction.user.guild_permissions.administrator:
            has_permission = True

        if not has_permission:
            await interaction.followup.send("❌ You don't have permission to add users to this ticket.", ephemeral=True)
            return
        
        try:
            # Check if user is already in the thread
            if user.id in [member.id for member in interaction.channel.members]:
                await interaction.followup.send(f"ℹ️ {user.mention} is already in this ticket.", ephemeral=True)
                return

            # Add the user to the thread
            await interaction.channel.add_user(user)
            
            # Send confirmation messages
            await interaction.followup.send(f"✅ Successfully added {user.mention} to the ticket.", ephemeral=True)
            await interaction.channel.send(
                f"{user.mention} has been added to the ticket by {interaction.user.mention}\n"
                f"Please describe your issue so we can help you!"
            )
            
            # Log the addition if log channel is set up
            if config.get("log_channel"):
                log_channel = interaction.guild.get_channel(config["log_channel"])
                if log_channel:
                    log_embed = discord.Embed(
                        title="User Added to Ticket",
                        description=(
                            f"**Thread:** {interaction.channel.mention}\n"
                            f"**Added by:** {interaction.user.mention}\n"
                            f"**User added:** {user.mention}"
                        ),
                        color=discord.Color.blue(),
                        timestamp=datetime.datetime.now()
                    )
                    await log_channel.send(embed=log_embed)

        except discord.Forbidden:
            await interaction.followup.send("❌ I don't have permission to add users to this thread.", ephemeral=True)
        except discord.HTTPException as e:
            print(f"Error adding user to ticket: {e}")
            await interaction.followup.send("❌ Failed to add user to the ticket. Please try again later.", ephemeral=True)